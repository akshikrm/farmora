
import { SubsriptionInActiveError } from "#errors/subscription.errors";
import { InvalidCredentialError, InvalidUsernameError, UserNotFoundError } from "#errors/user.errors";
import SubscriptionModel from "#models/subscription";
import UserModel from "#models/user";
// import { sendMail } from "./mailService.js";
import { sequelize } from "#utils/db"
import { Op, where } from "sequelize";
import subscriptionService from "#services/subscription.service";
import userRoles from "#utils/user-roles";
import dayjs from "dayjs";


const createManager = async (payload) => {
	const transaction = await sequelize.transaction();
	try {
		const newUser = await UserModel.create({
			name: payload.name,
			username: payload.username,
			password: payload.password,
			user_type: userRoles.manager.type,
			status: payload.status,
			parent_id: 1,
		}, { transaction });

		await subscriptionService.create(newUser.id, payload.package_id, transaction);

		// sendMail(
		// 	insertData.username,
		// 	"Your Account Details",
		// 	"accountCreated",
		// 	{
		// 		username: insertData.username,
		// 		password: hashedPassword,
		// 	}
		// );

		await transaction.commit();
		return newUser
	} catch (error) {
		await transaction.rollback();
		throw error
	}
}


const login = async (username, password) => {
	if (!username) {
		throw new InvalidUsernameError(username)
	}

	const now = dayjs().toDate();
	const user = await UserModel.findOne({
		where: {
			username: username,
		},
		include: [{
			model: SubscriptionModel,
			as: 'subscriptions',
			where: {
				valid_from: { [Op.lte]: now },
				valid_to: { [Op.gte]: now },
				deleted_at: null
			},
			required: true
		},]
	});
	console.log("parent", user);
	if (!user) {
		throw new UserNotFoundError(username)
	}


	const passwordVerified = await user.comparePassword(password);
	if (!passwordVerified) {
		throw new InvalidCredentialError(username)
	}

	if (user.user_type === userRoles.manager.type) {
		if (!user || user.subscriptions.length === 0) {
			throw new SubsriptionInActiveError(user.id);
		}
	}

	const date = dayjs().toDate();
	user.last_login = date;
	user.save();
	return user
}

const authService = {
	createManager: createManager,
	login: login,
};


export default authService;
